<div class="center">
  <%= form_for @encounter do |t|%>
    Edit Encounter with <%= @partner.name %>
    <br>
    <br>
    Took place on: <br>
    <%= t.date_select :took_place, selected: @encounter.took_place %>
    <br>
    <br>
    Self-assessed risk: <%= t.select :self_risk, options_for_select(1..10, @encounter.self_risk) %><br>
    <br>
    <%= t.label :notes %><br>
    <%= t.text_area :notes, value: @encounter.notes %><br>
    <%= t.hidden_field :partner_id, value: @encounter.partner_id %>
    <br>
    <% @possibilities.each do |inst, contact_types| %>
      <div class="bubble">

  <strong class="category">
    My
    <% if inst == :genitals && !@user.genital_name.empty? %>
      <%= @user.genital_name%>
    <% elsif inst == :anus && !@user.anus_name.empty?%>
      <%= @user.anus_name%>
    <% else %>
      <%= inst %>
    <% end %>
    <br>
  </strong>
  <div class="hidden">
    <% contact_types.each do|c_type, insts| %>
      <div class="contact-type">
        <span class="category">
          <% if c_type == "was penetrated by" && (insts[:user_instrument] == :toys || (insts[:user_instrument] == :genitals && (@user.genital_name.empty? || @user.genital_name.last == "s")))%>
            > were penetrated by
          <% else %>
            > <%= c_type %>
          <% end %>
          <%= @pronoun[:possessive] %>
        </span>
        <br>
        <div class="hidden">
          <% insts[:partner_instruments].each do |p_instrument| %>
            <%= t.fields_for :contacts, @encounter.contacts.build do |builder| %>
              <%= builder.check_box :partner_inst, {checked: @encounter.has_contact?(insts[:user_instrument], p_instrument)}, p_instrument, nil %>
              <% if (p_instrument == :genitals || p_instrument == :genitals_penetrative) && !@partner.genital_name.empty?%>
                <%= @partner.genital_name %>
              <% elsif p_instrument == :anus && !@partner.anus_name.empty? %>
                <%= @partner.anus_name  %>
              <% elsif p_instrument == :hand_penetrative %>
                hand
              <% else %>
                <%= p_instrument %>
              <% end %>
              <%= builder.hidden_field :user_inst, value: insts[:user_instrument] %>
              <%= builder.check_box :barriers, checked: @encounter.has_barriers?(insts[:user_instrument], p_instrument) %> with a barrier
              <% if p_instrument == :toys || insts[:user_instrument] == :toys %>
                (or sanitized)
              <% end %>
              <br>
            <% end %>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>
</div>

      <br>
    <% end %>
    <br>
    <%= t.check_box :fluid, value: true, checked: @encounter.fluid %>fluid exchange not accounted for (e.g. ejaculate in eyes, nose, or open cuts)<br>
    <br>
    <%= t.submit %>
  <% end %>
</div>
